"use strict";
const language_core_1 = require("@volar/language-core");
const typescript_1 = require("@volar/typescript");
const language_js_1 = require("./language.js");
const externalFiles = new WeakMap();
const init = (modules) => {
    const { typescript: ts } = modules;
    const pluginModule = {
        create(info) {
            const virtualFiles = (0, language_core_1.createVirtualFiles)([(0, language_js_1.getLanguageModule)(ts)]);
            (0, typescript_1.decorateLanguageService)(virtualFiles, info.languageService, true);
            (0, typescript_1.decorateLanguageServiceHost)(virtualFiles, info.languageServiceHost, ts, ['.astro']);
            // HACK: AutoImportProviderProject's script kind does not match the one of the language service host here
            // this causes TypeScript to throw and crash. So, we'll fake being a TS file here for now until they fix it
            const getScriptKind = info.languageServiceHost.getScriptKind?.bind(info.languageServiceHost.getScriptKind);
            if (getScriptKind) {
                info.languageServiceHost.getScriptKind = (fileName) => {
                    if (fileName.endsWith('.astro')) {
                        return ts.ScriptKind.TS;
                    }
                    return getScriptKind(fileName);
                };
            }
            return info.languageService;
        },
        getExternalFiles(project) {
            if (!externalFiles.has(project)) {
                externalFiles.set(project, (0, typescript_1.getExternalFiles)(ts, project, ['.astro']));
            }
            return externalFiles.get(project);
        },
    };
    return pluginModule;
};
module.exports = init;
